# -*- coding: utf-8 -*-

import urllib2, re
from colors import C

MESSAGE = C.BOLD + C.RED + "#TITLE" + C.NOFO
PREFIX = '(https?://)(www\.)?'
DERSTANDARD = ('derstandard.at',
        '(' + PREFIX + '(der|die|da)?standard\.at/.+/.+)',
        '<div class="artikelBody" id="artikelHeader"><h1>(.*)</h1>')
SOCIALISTWORKER = ('socialistworker.co.uk',
        '(' + PREFIX + 'socialistworker\.co\.uk/art.php\?id=.*)',
        '<title>(.*)\|.*\|.*</title>')
CODINGHORROR = ('codinghorror.com',
        '(' + PREFIX + 'codinghorror\.com/blog/.*)',
        '<title>(.*)</title>')
LINKSWENDE = ('linkswende.org',
        '(' + PREFIX + 'linkswende\.org/.*)',
        '<title>(.*) | .*</title>')
AMAZON = ('amazon',
        '(' + PREFIX + 'amazon\..{2,3}/.*)',
        '<span id="btAsinTitle">(.*?)<')
        #'<span id="btAsinTitle">(.*?)<span')
RUSSIA_TODAY = ('rt.com',
        '(' + PREFIX + 'rt\.com/.*)',
        '<title>(.*)&mdash; RT')
SLASHDOT = ('slashdot.org',
        '(' + PREFIX + '(.*\.)?slashdot\.org/.*)',
        '<title>(.*) - Slashdot')
NEWS = [DERSTANDARD, SOCIALISTWORKER, CODINGHORROR, LINKSWENDE, AMAZON, RUSSIA_TODAY, SLASHDOT]

class News(object):

    def parse(self, bot, msg, nick):
        # do not display
        if msg[-1] == '*':
            return

        # valid ?
        if not (msg.startswith("http://") or msg.startswith("https://") or msg.startswith("www.")):
            return

        # cut after url
        space = msg.find(" ")
        if space != -1:
            msg = msg[:space]

        for news in NEWS:
            match = re.search(news[1], msg)
            if not match:
                continue
            url = match.groups()[0]
            print("Found news from " + news[0] + "!")
            print("url: " + url)
        
            try:
                site = urllib2.urlopen(url)
            except:
                print("Error opening url!")

            content = site.read()
            match = re.search(news[2], content)
            if not match:
                print("Could not find title!")
                return

            title = match.groups()[0]
            title = title.replace('&uuml;', 'ü')
            title = title.replace('&auml;', 'ä')
            title = title.replace('&ouml;', 'ö')
            return MESSAGE.replace('#TITLE', title)
